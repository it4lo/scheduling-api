version: 2


jobs:
  build:
    docker:
    - image: circleci/node:12.21.0
    working_directory: ~/workspace
    steps:
      - checkout
      - run: yarn 
      - run: yarn build
      - persist_to_workspace:
          root: /home/circleci/workspace
          paths:
          - .
  deploy:
    machine:
      image: circleci/classic:latest
    steps:
      - attach_workspace:
          at: ~/workspace
      - add_ssh_keys:
          fingerprints:
          - "0f:81:0b:37:5a:1a:92:58:fa:c4:a3:76:b0:37:db:bb"
      - run:
          name: "Deploy"
          command: | 
            export USER_HOST="root@104.131.11.225"
            tar -czf /tmp/build.tar.gz -C ~/workspace/dist .
            
            ssh ${USER_HOST} '
            cd ../; 
            rm -Rf /var/www/intra/source/client/build';'

            scp -r /tmp/build.tar.gz ${USER_HOST}:~/apps/intra/front/build.tar.gz
            ssh ${USER_HOST} '
            cd ~/apps/intra/front;
            tar -xzf ./build.tar.gz;
            cd ~;
            cd ..; 
            rm -rf /var/www/intra/source/client/build;
            cp ~/apps/intra/front/build/ /var/www/intra/source/client/;
workflows:
  version: 2
  ci-dploy:
    jobs:
      - build
      - deploy:
          requires:
            - build
     

